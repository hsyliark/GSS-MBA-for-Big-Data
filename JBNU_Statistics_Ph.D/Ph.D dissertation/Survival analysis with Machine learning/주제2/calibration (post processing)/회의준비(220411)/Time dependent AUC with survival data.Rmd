---
title: "Time dependent AUC with survival data"
author: "Hwang Seong-Yun"
date: '2022 4 7 '
output: html_document
---

# Loading packages

```{r}
library(survival)
library(timeROC)
library(timereg)
library(ggplot2)
library(reshape)
library(plyr)
library(tidyverse)
library(coxed)
library(gridExtra)
```

# Generating simulation data from Cox Proportional Hazard Model

## Assume linear relationship
- reference : http://koreascience.or.kr/article/JAKO201810866005356.page

- $h(t|x)=h_{0}(t)exp(\beta x)$
- $H(t|x)=\int_{0}^{t} h(s|x)ds= \int_{0}^{t} h_{0}(s)exp(\beta x)ds=H_{0}(t)exp( \beta x)$
- $h(t|x)=\frac {f(t|x)}{S(t|x)}= -\frac {d}{dt} log[S(t|x)]$
- $log[S(t|x)]= -\int_{0}^{t} h(s|x)ds= -H(t|x)= -H_{0}(t)exp(\beta x)$
- $S(t|x)=exp[-H_{0}(t)exp(\beta x)]$

- In general,...
- $F(t|x)=1-exp[-H_{0}(t) exp(\beta x)]$
- -> $F^{-1}(t|x)=H_{0}^{-1}[-log(1-t) exp(-\beta x)]$
- By Inverse Transform Sampling, suppose that $U \sim U(0,1)$, then we can generate real survival time $Y$ from Cox Proportional Hazard Model using this equation.
- $Y=H_{0}^{-1}[-log(U)exp(\beta x)]$
- And by assuming non-informative censoring, we can generate censoring time $C$ like this equation.
- $C=H_{0}^{-1}[-log(U)]$
- And set censoring indicator $\delta=I(Y \leq C)$ and observed survival time $T=min(Y,C)$

- When parametric basis distribution of survival time $T$ is Exponential distribution($Exp(\lambda)$), then ~
- $f_{0}(t)=\lambda e^{-\lambda t}, t>0$ -> $S_{0}(t)=e^{-\lambda t}$ -> $h_{0}(t)=\lambda$
- $\therefore Y=-\frac{1}{\lambda} log(U) exp(\beta x)$, $C=-\frac{1}{\lambda} log(U)$

- Suppose that parametric basis distribution is Exponential distribution($Exp(\lambda)$), then ~
- $f_{0}(t)=\lambda e^{-\lambda t}, t>0$ -> $S_{0}(t)=e^{-\lambda t}$ -> $h_{0}(t)=\lambda$
- $\therefore S(t|x)=exp[-(\lambda t)exp(\beta x)]=exp(-C_{x}t)$
- (Put $\lambda exp(\beta x)=C_{x}$ and fixed $\lambda=\lambda_{0}$, $\beta=\beta_{0}$)
- $\therefore F(t|x)=1-S(t|x)=1-exp(-C_{x}t)$ -> $Exp(C_{x})$

- $X \sim N(0,3^2)$
- Censoring rate : $0.3$, set $\lambda_{0}=2$ and $\beta_{0}=3$







### Generating simulation data

```{r}
# Assume parametric basis distribution is Exponential distribution Exp(2)... 
lambda0 <- 2
beta0 <- 3
Y <- c() # real survival time
C <- c() # censoring time
t <- c() # observed survival time
censor <- c() # censoring indicator
X <- c() # covariance
U <- c() # random variable from U(0,1)

for (i in 1:1000) {
  U[i] <- runif(1)
  X[i] <- rnorm(1,mean=0,sd=3)
  Y[i] <- -(1/lambda0)*log(U[i])*exp(beta0*X[i])
  C[i] <- -(1/lambda0)*log(U[i])
  t[i] <- min(Y[i],C[i])
  censor[i] <- ifelse(Y[i]<=C[i],1,0)
}
dt1 <- data.frame(x=X, time=t, censor=censor)
```

### Time dependent AUC

### Assuming linear

- $h(t|x)=h _{0} (t)exp[f(x)]$
- $f(x)=\beta_{1}x$

```{r}
cox.lin.dt1 <- coxph(Surv(time,censor) ~ X, data=dt1)
summary(cox.lin.dt1)
risk.lin.dt1 <- predict(object=cox.lin.dt1, newdata=dt1, type="risk") # risk score
dt1$risk.lin.dt1 <- risk.lin.dt1
ROC.risk.lin.dt1 <- timeROC(T=dt1$time,
                         delta=dt1$censor,marker=dt1$risk.lin.dt1,
                         cause=1,weighting="marginal",
                         times=dt1$time)
ROC.risk.lin.dt1
```





