---
title: "Time dependent ROC curve with Cox regression"
author: "Hwang Seong-Yun"
date: '2022 3 23 '
output: html_document
---

# Time dependent ROC curve with Cox regression

## Loading packages

```{r}
library(survival)
library(timeROC)
library(timereg)
```

## pbc data

```{r}
data(pbc)
pbc<-pbc[,-1] # delete ID
pbc$status<-as.numeric(pbc$status==2) # create event indicator: 1 for death, 0 for censored
head(pbc)
```

### Calculate risk score with Cox proportional hazard model

```{r}
cox.pbc <- coxph(Surv(time,status) ~ ., data=pbc)
summary(cox.pbc)
risk.pbc <- predict(object=cox.pbc, newdata=pbc, type="risk") # risk score
pbc$risk <- risk.pbc
pbc <- pbc[!is.na(pbc$risk),]
head(pbc)
```

### Time dependent AUC with risk score

```{r}
ROC.risk.marginal <- timeROC(T=pbc$time,
                         delta=pbc$status,marker=pbc$risk,
                         cause=1,weighting="marginal",
                         times=pbc$time)
ROC.risk.marginal

# plot all ROC curves 
par(mar=c(2,2,2,2))
plot(ROC.risk.marginal,time=1191,lwd=2,title=FALSE)
plot(ROC.risk.marginal,time=1786,col="blue",add=TRUE,lwd=2,lty=2)
plot(ROC.risk.marginal,time=2689,col="black",add=TRUE,lwd=2,lty=3)
# add legend
legend("bottomright",c("t=1191","t=1786","t=2689"),
       col=c("red","blue","black"),lty=1:3)
```

### time VS AUC

#### Make density of time 

```{r}
time.density <- density(ROC.risk.marginal[["times"]])
data1 <- data.frame(time=time.density[["x"]], density=time.density[["y"]])
data1$density.normal1 <- 0.9*(time.density[["y"]]-min(time.density[["y"]]))/(max(time.density[["y"]])-min(time.density[["y"]]))
data1$density.normal2 <- 0.9*(max(na.omit(ROC.risk.marginal[["AUC"]]))-min(na.omit(ROC.risk.marginal[["AUC"]])))*(time.density[["y"]]-min(time.density[["y"]]))/(max(time.density[["y"]])-min(time.density[["y"]]))+min(na.omit(ROC.risk.marginal[["AUC"]])) 
```

#### Plot of density of time 

```{r}
par(mar=c(2,2,2,2))
plot(time.density)
rug(jitter(ROC.risk.marginal[["times"]]))
```

#### Coloring status

```{r}
pbc$status.color <- ifelse(pbc$status==1,"seagreen","darkred")
pbc$status1 <- ifelse(pbc$status==1,pbc$status,min(na.omit(ROC.risk.marginal[["AUC"]])))
head(pbc)
```

#### Plot of Time dependent AUC with Adjusted Density of time and Status of censoring

```{r}
par(mar=c(2,2,2,2))
plot(x=ROC.risk.marginal[["times"]],y=ROC.risk.marginal[["AUC"]],
     type="l",xlab="times",ylab="AUC",lwd=2,
     main="Time dependent AUC with risk score (pbc data)")
lines(x=data1$time,y=data1$density.normal2,col="steelblue",type="l",lwd=2)
points(x=pbc$time,y=pbc$status1,col=pbc$status.color,pch=20)
rug(jitter(ROC.risk.marginal[["times"]]))
legend(500,0.8,c("AUC","Density of time(adjusted)","censored(status=0)"),
       col=c("black","steelblue","darkred"),lwd=c(2,2,2),lty=c(1,1,2))
```

```{r}
par(mar=c(2,2,2,2))
plot(x=ROC.risk.marginal[["times"]],y=ROC.risk.marginal[["AUC"]],
     type="l",xlab="times",ylab="AUC",ylim=c(0,1),lwd=2,
     main="Time dependent AUC with risk score (pbc data) / ylim=c(0,1)")
lines(x=data1$time,y=data1$density.normal1,col="steelblue",type="l",lwd=2)
points(x=pbc$time,y=pbc$status,col=pbc$status.color,pch=20)
rug(jitter(ROC.risk.marginal[["times"]]))
legend(990,0.4,c("AUC","Density of time(adjusted)","censored(status=0)"),
       col=c("black","steelblue","darkred"),lwd=c(2,2,2),lty=c(1,1,2))
```

### Variable selection (backward)

#### All explanatory variables

```{r}
data(pbc)
pbc<-pbc[,-1] # delete ID
pbc$status<-as.numeric(pbc$status==2) # create event indicator: 1 for death, 0 for censored
cox.pbc0 <- coxph(Surv(time,status) ~ trt+age+sex+ascites+hepato+spiders+edema
                 +bili+chol+albumin+copper+alk.phos+ast+trig
                 +platelet+protime+stage, data=pbc)
summary(cox.pbc0)
risk.pbc0 <- predict(object=cox.pbc0, newdata=pbc, type="risk") # risk score
pbc$risk0 <- risk.pbc0
pbc <- pbc[!is.na(pbc$risk0),]
```

#### Except explanatory variables with (p-value > 0.5)

```{r}
cox.pbc1 <- coxph(Surv(time,status) ~ age+sex+edema
                 +bili+chol+albumin+copper+ast+trig
                 +platelet+protime+stage, data=pbc)
summary(cox.pbc1)
risk.pbc1 <- predict(object=cox.pbc1, newdata=pbc, type="risk") # risk score
pbc$risk1 <- risk.pbc1
```

#### Except explanatory variables with (p-value > 0.5)

```{r}
cox.pbc2 <- coxph(Surv(time,status) ~ age+sex+edema
                 +bili+chol+albumin+copper+ast+protime+stage, data=pbc)
summary(cox.pbc2)
risk.pbc2 <- predict(object=cox.pbc2, newdata=pbc, type="risk") # risk score
pbc$risk2 <- risk.pbc2
```

#### Except explanatory variables with (p-value > 0.3)

```{r}
cox.pbc3 <- coxph(Surv(time,status) ~ age+edema
                 +bili+chol+albumin+copper+ast+protime+stage, data=pbc)
summary(cox.pbc3)
risk.pbc3 <- predict(object=cox.pbc3, newdata=pbc, type="risk") # risk score
pbc$risk3 <- risk.pbc3
```

#### Except explanatory variables with (p-value > 0.1)

```{r}
cox.pbc4 <- coxph(Surv(time,status) ~ age+edema+bili+albumin+copper+ast+protime+stage, data=pbc)
summary(cox.pbc4)
risk.pbc4 <- predict(object=cox.pbc4, newdata=pbc, type="risk") # risk score
pbc$risk4 <- risk.pbc4
```

#### Time dependent AUC with Backward elimination

```{r}
ROC.risk.marginal0 <- timeROC(T=pbc$time,
                         delta=pbc$status,marker=pbc$risk0,
                         cause=1,weighting="marginal",
                         times=pbc$time)
ROC.risk.marginal0
ROC.risk.marginal1 <- timeROC(T=pbc$time,
                         delta=pbc$status,marker=pbc$risk1,
                         cause=1,weighting="marginal",
                         times=pbc$time)
ROC.risk.marginal1
ROC.risk.marginal2 <- timeROC(T=pbc$time,
                         delta=pbc$status,marker=pbc$risk2,
                         cause=1,weighting="marginal",
                         times=pbc$time)
ROC.risk.marginal2
ROC.risk.marginal3 <- timeROC(T=pbc$time,
                         delta=pbc$status,marker=pbc$risk3,
                         cause=1,weighting="marginal",
                         times=pbc$time)
ROC.risk.marginal3
ROC.risk.marginal4 <- timeROC(T=pbc$time,
                         delta=pbc$status,marker=pbc$risk4,
                         cause=1,weighting="marginal",
                         times=pbc$time)
ROC.risk.marginal4
```

```{r}
time.density <- density(ROC.risk.marginal[["times"]])
data1 <- data.frame(time=time.density[["x"]], density=time.density[["y"]])
data1$density.normal1 <- 0.9*(time.density[["y"]]-min(time.density[["y"]]))/(max(time.density[["y"]])-min(time.density[["y"]]))
data1$density.normal2 <- 0.9*(max(na.omit(ROC.risk.marginal0[["AUC"]]))-min(na.omit(ROC.risk.marginal0[["AUC"]])))*(time.density[["y"]]-min(time.density[["y"]]))/(max(time.density[["y"]])-min(time.density[["y"]]))+min(na.omit(ROC.risk.marginal0[["AUC"]]))
```

```{r}
pbc$status.color <- ifelse(pbc$status==1,"seagreen","darkred")
pbc$status1 <- ifelse(pbc$status==1,1,0.7)
head(pbc)
```

#### Plot of Time dependent AUC with Adjusted Density of time and Status of censoring

```{r}
par(mar=c(2,2,2,2))
plot(x=ROC.risk.marginal0[["times"]],y=ROC.risk.marginal0[["AUC"]],
     type="l",xlab="times",ylab="AUC",lwd=1,lty=1,col="black",ylim=c(0.7,1),
     main="Time dependent AUC with risk score (pbc data)")
lines(x=ROC.risk.marginal1[["times"]],y=ROC.risk.marginal1[["AUC"]],
     type="l",xlab="times",ylab="AUC",lwd=1,lty=1,col="red")
lines(x=ROC.risk.marginal2[["times"]],y=ROC.risk.marginal2[["AUC"]],
     type="l",xlab="times",ylab="AUC",lwd=1,lty=1,col="blue")
lines(x=ROC.risk.marginal3[["times"]],y=ROC.risk.marginal3[["AUC"]],
     type="l",xlab="times",ylab="AUC",lwd=1,lty=1,col="green")
lines(x=ROC.risk.marginal4[["times"]],y=ROC.risk.marginal4[["AUC"]],
     type="l",xlab="times",ylab="AUC",lwd=1,lty=1,col="yellow")
lines(x=data1$time,y=data1$density.normal2,col="steelblue",type="l",lwd=2)
points(x=pbc$time,y=pbc$status1,col=pbc$status.color,pch=20)
rug(jitter(ROC.risk.marginal[["times"]]))
legend(500,0.83,c("AUC(cox.pbc0)","AUC(cox.pbc1)","AUC(cox.pbc2)","AUC(cox.pbc3)","AUC(cox.pbc4)","Density of time(adjusted)","censored(status=0)"),col=c("black","red","blue","green","yellow","steelblue","darkred"),lwd=c(1,1,1,1,1,1,1),lty=c(1,1,1,1,1,1,2))
```

#### Mean value of Time dependent AUC

```{r}
mean(ROC.risk.marginal0[["AUC"]],na.rm=TRUE)
mean(ROC.risk.marginal1[["AUC"]],na.rm=TRUE)
mean(ROC.risk.marginal2[["AUC"]],na.rm=TRUE)
mean(ROC.risk.marginal3[["AUC"]],na.rm=TRUE)
mean(ROC.risk.marginal4[["AUC"]],na.rm=TRUE)
```

