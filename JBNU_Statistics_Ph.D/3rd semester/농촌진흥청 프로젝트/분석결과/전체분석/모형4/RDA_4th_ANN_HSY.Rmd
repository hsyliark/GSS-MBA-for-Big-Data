---
title: "RDA project"
author: "JBNU statistics"
date: '2021 12 14 '
output: html_document
---

## 목적 : 단동 비닐하우스 환기율 및 온습도에 대한 예측모형 구축 및 평가
## 사용모형 : Multiple Linear Regression Model v.s Artificial Neural Network Model (ANN)

## 1. Loading data (내부상대습도 반응변수)

- 작물있음 데이터에서 외부CO2의 값이 결측치인 경우는 제외하였음.

```{r}
plantyes <- read.csv("C:/Users/HSY/Desktop/작물있음.csv",sep=",",header=T)
plantyes <- plantyes[is.na(plantyes$외부CO2)==FALSE,]
head(plantyes,10)
plantyes$작물유무 <- as.factor(plantyes$작물유무)
plantno <- read.csv("C:/Users/HSY/Desktop/작물없음.csv",sep=",",header=T)
head(plantno,10) 
plantno$작물유무 <- as.factor(plantno$작물유무)
plant <- rbind(plantno,plantyes)
```






## Artificial Neural Network Model (ANN)

- ANN의 경우는 작물이 없을 때와 작물이 있을 때로 나누어 각각 모형을 적합하고 분석을 실시한다.
- 모형적합은 데이터에서 임의로 70%를 추출한 train data를 이용하여 만들고 이 모형의 성능을 판단하기 위해 나머지 30%를 test data로 두어서 test RMSE를 계산한다.
- 추가로 모형적합의 효율성을 위해 주어진 데이터에 대해 최댓값 1, 최솟값 0을 기준으로 하는 표준화를 실시하고 모형을 적합하였다.
- 그리고 분석 의뢰기관의 요청에 따라 환기율은 설명변수에서 제외하였다.

## 3. 작물유무에 따라 데이터를 나누어 적합하는 경우

### Loading packages

```{r}
library(nnet)
library(devtools)
library(neuralnet)
library(NeuralNetTools)
```


### 3.1 작물이 없을 때

- 적합모형은 hidden layer 20개, 각 layer에 대한 node 10개인 모형이다.
- activation function은 `logistic`으로 설정하였다.

```{r}
plantno_scale <- transform(plantno[,c(5,12,1,4,10,11,13)], 
                           내부상대습도=(내부상대습도-min(내부상대습도))/(max(내부상대습도)-min(내부상대습도)),
                           환기율=(환기율-min(환기율))/(max(환기율)-min(환기율)),
                           외부기온=(외부기온-min(외부기온))/(max(외부기온)-min(외부기온)),
                           외부상대습도=(외부상대습도-min(외부상대습도))/(max(외부상대습도)-min(외부상대습도)),
                           외부풍속=(외부풍속-min(외부풍속))/(max(외부풍속)-min(외부풍속)),
                           외부일사량=(외부일사량-min(외부일사량))/(max(외부일사량)-min(외부일사량)),
                           환기창면적=(환기창면적-min(환기창면적))/(max(환기창면적)-min(환기창면적)))
set.seed(5790)
train.index <- sample(1:nrow(plantno_scale), round(nrow(plantno_scale)*7/10), replace=F)
ex1_train <-as.data.frame(plantno_scale[train.index,])
ex1_test <- as.data.frame(plantno_scale[-train.index,])
# set.seed(5790)
# train.index <- sample(1:nrow(plantno), round(nrow(plantno)*7/10), replace=F)
# ex1_train <-plantno[train.index,]
# ex1_test <- plantno[-train.index,]
set.seed(1234)
ann1 <- neuralnet(내부상대습도~외부기온+외부상대습도+외부풍속+외부일사량+환기창면적, data=ex1_train, hidden=rep(10,20), threshold = 0.01, stepmax = 1e+08)
summary(ann1)
y_hat_ann1 <- compute(ann1, ex1_test)$net.result
RMSE <- mean(sum(((ex1_test$내부상대습도-y_hat_ann1)*(max(plantno$내부상대습도)-min(plantno$내부상대습도))+min(plantno$내부상대습도))^2))
RMSE
```

- 적합결과 test RMSE의 값이 52681.1로 산출되었다. 이는 다중회귀모형과 비교했을 때 좋지 않은 결과인데, 이미 구축한 다중회귀모형이 데이터를 충분히 잘 설명하도록 만들어졌기 때문이라고 생각한다.


### 3.2 작물이 있을 때

- 적합모형은 hidden layer 20개, 각 layer에 대한 node 10개인 모형이다.
- activation function은 `logistic`으로 설정하였다.

```{r}
plantyes_scale <- transform(plantyes[,c(5,12,1,4,10,11,13)], 
                           내부상대습도=(내부상대습도-min(내부상대습도))/(max(내부상대습도)-min(내부상대습도)),
                           환기율=(환기율-min(환기율))/(max(환기율)-min(환기율)),
                           외부기온=(외부기온-min(외부기온))/(max(외부기온)-min(외부기온)),
                           외부상대습도=(외부상대습도-min(외부상대습도))/(max(외부상대습도)-min(외부상대습도)),
                           외부풍속=(외부풍속-min(외부풍속))/(max(외부풍속)-min(외부풍속)),
                           외부일사량=(외부일사량-min(외부일사량))/(max(외부일사량)-min(외부일사량)),
                           환기창면적=(환기창면적-min(환기창면적))/(max(환기창면적)-min(환기창면적)))
set.seed(5790)
train.index <- sample(1:nrow(plantyes_scale), round(nrow(plantyes_scale)*7/10), replace=F)
ex1_train <- as.data.frame(plantyes_scale[train.index,])
ex1_test <- as.data.frame(plantyes_scale[-train.index,])
# set.seed(5790)
# train.index <- sample(1:nrow(plantyes), round(nrow(plantyes)*7/10), replace=F)
# ex1_train <-plantyes[train.index,]
# ex1_test <- plantyes[-train.index,]
set.seed(1234)
ann1 <- neuralnet(내부상대습도~외부기온+외부상대습도+외부풍속+외부일사량+환기창면적, data=ex1_train, hidden=rep(10,20), threshold = 0.01, stepmax = 1e+08)
summary(ann1)
y_hat_ann1 <- compute(ann1, ex1_test)$net.result
RMSE <- mean(sum(((ex1_test$내부상대습도-y_hat_ann1)*(max(plantyes$내부상대습도)-min(plantyes$내부상대습도))+min(plantyes$내부상대습도))^2))
RMSE
```

- 적합결과 test RMSE의 값이 202594.5로 산출되었다. 이는 다중회귀모형과 비교했을 때 좋지 않은 결과인데, 이미 구축한 다중회귀모형이 데이터를 충분히 잘 설명하도록 만들어졌기 때문이라고 생각한다.
