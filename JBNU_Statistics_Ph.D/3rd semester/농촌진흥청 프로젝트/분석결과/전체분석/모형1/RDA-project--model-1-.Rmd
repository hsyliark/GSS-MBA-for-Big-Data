---
title: "RDA project (model 1)"
author: "JBNU statistics"
date: '2021 11 9 '
output: html_document
---

# RDA project

## 목적 : 단동 비닐하우스 환기율 및 온습도에 대한 예측모형 구축 및 평가
## 사용모형 : Multiple Linear Regression Model v.s Artificial Neural Network Model (ANN)

### Loading data

- 작물있음 데이터에서 외부CO2의 값이 결측치인 경우는 제외하였음.

```{r}
plantyes <- read.csv("C:/Users/HSY/Desktop/작물있음.csv",sep=",",header=T)
plantyes <- plantyes[is.na(plantyes$외부CO2)==FALSE,]
head(plantyes,10)
plantyes$작물유무 <- as.factor(plantyes$작물유무)
plantno <- read.csv("C:/Users/HSY/Desktop/작물없음.csv",sep=",",header=T)
head(plantno,10) 
plantno$작물유무 <- as.factor(plantno$작물유무)
plant <- rbind(plantno,plantyes)
```

### Open library

```{r}
library(nnet)
library(devtools)
library(neuralnet)
library(NeuralNetTools)
```

- 작물유무에 따라 데이터를 나누어서 사전분석을 실시한 결과 구축된 모형에 많은 차이가 있었다. 이에 따라 작물있음 데이터와 작물없음 데이터를 합친 데이터에 대해 작물유무와 다른 독립변수들간의 교호작용을 포함한 모형을 적합하여 결과를 살펴보았다.





# model 1 : 환기율 ~ 외부기온, 외부풍속, 외부일사량, 환기창면적, 작물유무



## Multiple Linear Regression Model

- 먼저 변수들 간의 상관관계를 파악하기 위해 상관분석을 실시한다.

```{r}
ex1 <- plant[,c(12,1,10,11,13,14,15)]
head(ex1)
```

```{r}
cor(ex1[,-6])
```

- 분석결과, pearson 표본상관계수에 따르면 환기율과 외부일사량, 외부기온과 외부풍속, 환기창면적과 외부풍속, 환기창면적과 외부일사량, 작물유무와 외부풍속, 작물유무와 외부일사량은 음의 상관관계를 보이고 있으며, 나머지는 모두 양의 상관관계를 보이고 있다. 이에 대해 산점도행렬과 상관계수그림을 그리면 다음과 같다.

```{r}
pairs(ex1[,-7])
```

```{r}
library(corrplot)
corrplot(cor(ex1[,-6]))
```

- 그리고 각 변수에 대한 기초통계량은 다음과 같이 계산된다. 이 결과에 의하면 5가지 변수들 중 외부일사량이 가장 변동이 크다고 할 수 있다.

```{r}
library(psych)
describe(ex1[,c(-6,-7)])
```

- 환기율을 반응변수로 하여 다중선형회귀모형을 적합하면 다음과 같다.

```{r}
m0 <- lm(환기율~외부기온+외부풍속+외부일사량+환기창면적+작물유무+
              외부기온*작물유무+외부풍속*작물유무+
              외부일사량*작물유무+환기창면적*작물유무,
            data=ex1)
summary(m0)
```

- 모형적합 결과 외부풍속, 외부일사량, 환기창면적, 작물유무 모두 환기율에 유의미한 영향을 미치고 있다. 이에 반해 외부기온의 경우는 교호작용이 포함되지 않은 변수의 경우는 유의성이 없지만, 교호작용이 포함된 변수의 경우는 유의성이 있기 때문에 작물유무에 따라 유의성이 달라진다고 할 수 있다. 다시 말해서 전체적으로 모든 설명변수가 환기율에 유의미한 영향을 주고 있는 것이다. 그리고 조절된 결정계수의 값이 $R^2_{adj}=0.9602$이므로 이 모형은 데이터의 변동을 약 $96%$ 정도 설명하고 있으므로 설명력도 크다는 것을 알 수 있다. 모형식은 다음과 같이 적을 수 있다.
- ${\hat{y}} = -2.2977 + 0.0002x_{1} + 0.7685x_{2} + 0.0004x_{3} + 30.2437x_{4} - 1.1729x_{5} - 0.0412x_{1}x_{5} + 1.2095x_{2}x_{5} + 0.0011x_{3}x_{5} + 14.9740x_{4}x_{5}$
- $y$ : 환기율, $x _{1}$ : 외부기온, $x _{2}$ : 외부풍속, $x_{3}$ : 외부일사량, $x_{4}$ : 환기창면적, $x _{5}$ : 작물유무yes
- 이 모형을 이용하여 환기율의 예측값을 구하고 이를 바탕으로 예측력의 정확성을 판단하는 기준인 RMSE를 계산하도록 한다. 이는 다음과 같이 계산한다.
- $RMSE = \frac {1} {n} \sqrt {\sum _{i=1} ^{n} (y _{i} - {\hat{y _{i}}} ) ^{2}}$

```{r}
y_hat <- predict(m0,ex1)
RMSE <- mean(sum((ex1$환기율-y_hat)^2))
RMSE
```

- 결과적으로 산출되는 RMSE는 $RMSE=449.2098$이다.
- 하지만 이 결과는 모형적합 후 단순히 유의한 영향력이 있는지를 확인한 것에 불과하다. 이에 따라 best subset selection 방법을 통해 모형을 다시 선택해볼 것이며, train:test=7:3 으로 데이터를 나누어서 4개의 교호작용 term을 하나씩 제외한 모형들과 모두 포함한 모형을 test RMSE의 관점에서 비교해볼 것이다.

### Best subset selection

```{r}
library(leaps)
ms0 <- regsubsets(환기율~외부기온+외부풍속+외부일사량+환기창면적+작물유무+
              외부기온*작물유무+외부풍속*작물유무+
              외부일사량*작물유무+환기창면적*작물유무,
            data=ex1,nvmax=9)
ms0.summary <- summary(ms0)
ms0.summary
```

- Best subset selection의 결과를 보면 설명변수의 개수에 따라 어떤 변수를 넣는것이 바람직한지를 제시하고 있다. 바람직한 설명변수의 개수를 선택하는 데 있어 기준이 되는 통계량 중 $RSS$, $R^2_{adj}$, $C_{p}$, $BIC$를 기준으로 몇개의 설명변수를 선택하는 것이 바람직한지를 살펴보면 다음과 같다. 다만, $RSS$는 설명변수의 개수가 증가할수록 감소하는 특징이 있기 때문에 변수의 개수를 선택하는 기준으로서는 그다지 바람직하지 않다고 할 수 있다.

```{r}
par(mfrow=c(2,2)) 
# RSS=SSE
plot(ms0.summary$rss,xlab="Number of Variables",ylab="RSS",type="l")
# Adj R^2
plot(ms0.summary$adjr2,xlab="Number of Variables",ylab="Adjusted RSq",type="l")
which.max(ms0.summary$adjr2)
points(8,ms0.summary$adjr2[8], col="red",cex=2,pch=20)
# Cp
plot(ms0.summary$cp,xlab="Number of Variables",ylab="Cp",type='l') 
which.min(ms0.summary$cp)
points(8,ms0.summary$cp[8],col="red",cex=2,pch=20)
# BIC
plot(ms0.summary$bic,xlab="Number of Variables",ylab="BIC",type='l')
which.min(ms0.summary$bic) 
points(8,ms0.summary$bic[8],col="red",cex=2,pch=20)
par(mfrow=c(1,1))
```

```{r}
plot(ms0,scale="adjr2")
plot(ms0,scale="Cp")
plot(ms0,scale="bic")
```

- 위의 결과를 보면 $R^2_{adj}$, $C_{p}$, $BIC$ 모두 8개의 설명변수를 선택하는 것이 가장 바람직하다는 결과를 주고 있다. 이에 따라 외부기온 term을 제외한 다음과 같은 모형을 선택할 수 있다. 하지만 이미 외부기온과 작물유무에 대한 교호작용 term이 포함되어 있기 때문에 결과적으로는 모든 term을 포함한 모형과 같음을 확인할 수 있다.

```{r}
ms0.res <- lm(환기율~외부풍속+외부일사량+환기창면적+작물유무+
              외부기온*작물유무+외부풍속*작물유무+
              외부일사량*작물유무+환기창면적*작물유무,
            data=ex1)
summary(ms0.res)
```

- 결과적으로 Best subset selection에 따라 선택된 모형식은 다음과 같다.
- ${\hat{y}} = -2.2977 + 0.0002x_{1} + 0.7685x_{2} + 0.0004x_{3} + 30.2437x_{4} - 1.1729x_{5} - 0.0412x_{1}x_{5} + 1.2095x_{2}x_{5} + 0.0011x_{3}x_{5} + 14.9740x_{4}x_{5}$
- $y$ : 환기율, $x _{1}$ : 외부기온, $x _{2}$ : 외부풍속, $x_{3}$ : 외부일사량, $x_{4}$ : 환기창면적, $x _{5}$ : 작물유무yes

### train:test

- 지금부터는 train:test=7:3 으로 데이터를 나누어서 4개의 교호작용 term을 하나씩 제외한 모형들과 모두 포함한 모형을 test RMSE의 관점에서 비교해볼 것이다. test RMSE가 작을수록 예측을 잘하는 모형이라고 해석하면 된다.
- 먼저 데이터를 임의로 train:test=7:3 의 비율로 나눈다. train data는 모형구축 시, test data는 구축된 모형을 평가 시 사용한다.

```{r}
set.seed(5790)
train.index <- sample(1:nrow(ex1), round(nrow(ex1)*7/10), replace=F)
ex1_train <- ex1[train.index,]
ex1_test <- ex1[-train.index,]
```

```{r}
m0 <- lm(환기율~외부기온+외부풍속+외부일사량+환기창면적+작물유무+
              외부기온*작물유무+외부풍속*작물유무+
              외부일사량*작물유무+환기창면적*작물유무,
            data=ex1_train) # 모든 변수 포함
y_hat0 <- predict(m0,ex1_test)
RMSE0 <- mean(sum((ex1_test$환기율-y_hat0)^2))
RMSE0
m1 <- lm(환기율~외부기온+외부풍속+외부일사량+환기창면적+작물유무+
              외부풍속*작물유무+
              외부일사량*작물유무+환기창면적*작물유무,
            data=ex1_train) # 외부기온*작물유무 제외
y_hat1 <- predict(m1,ex1_test)
RMSE1 <- mean(sum((ex1_test$환기율-y_hat1)^2))
RMSE1
m2 <- lm(환기율~외부기온+외부풍속+외부일사량+환기창면적+작물유무+
              외부기온*작물유무+
              외부일사량*작물유무+환기창면적*작물유무,
            data=ex1_train) # 외부풍속*작물유무 제외
y_hat2 <- predict(m2,ex1_test)
RMSE2 <- mean(sum((ex1_test$환기율-y_hat2)^2))
RMSE2
m3 <- lm(환기율~외부기온+외부풍속+외부일사량+환기창면적+작물유무+
              외부기온*작물유무+외부풍속*작물유무+
              환기창면적*작물유무,
            data=ex1_train) # 외부일사량*작물유무 제외
y_hat3 <- predict(m3,ex1_test)
RMSE3 <- mean(sum((ex1_test$환기율-y_hat3)^2))
RMSE3
m4 <- lm(환기율~외부기온+외부풍속+외부일사량+환기창면적+작물유무+
              외부기온*작물유무+외부풍속*작물유무+
              외부일사량*작물유무,
            data=ex1_train) # 환기창면적*작물유무 제외
y_hat4 <- predict(m4,ex1_test)
RMSE4 <- mean(sum((ex1_test$환기율-y_hat4)^2))
RMSE4
```

- 결과적으로 5가지 모형들 중 모든 교호작용을 다 포함한 모형에 대한 test RMSE의 값이 가장 작음을 확인할 수 있다. 이 모형식은 다음과 같다.

```{r}
summary(m0)
```

- ${\hat{y}} = -2.3475 + 0.0034x_{1} + 0.7597x_{2} + 0.0003x_{3} + 30.4068x_{4} - 1.1008x_{5} - 0.0436x_{1}x_{5} + 1.2213x_{2}x_{5} + 0.0011x_{3}x_{5} + 14.6809x_{4}x_{5}$
- $y$ : 환기율, $x _{1}$ : 외부기온, $x _{2}$ : 외부풍속, $x_{3}$ : 외부일사량, $x_{4}$ : 환기창면적, $x _{5}$ : 작물유무yes



## ANN Model

- ANN 모형의 경우는 다음과 같이 적합할 수 있다. hidden node의 경우는 개수를 결정하는 기준점이 따로 정해져있지 않기 때문에 최적의 hidden node의 개수를 미리 정한다는 것은 매우 어려운 일이다. 이에 따라 우선적으로 hidden layer의 개수는 2, 그리고 각각의 layer에 대한 node의 수는 2로 설정한다. 
- 한가지 주의할 점은 ANN의 경우는 기본적으로 모든 설명변수들을 다 사용하게 되지만 정확한 모형식은 알 수 없기 때문에 각 설명변수의 유의성은 판단할 수 없다는 것이다.
- `neuralnet` 함수는 실행할 때마다 결과값이 다르게 나오기 때문에 `set.seed()`를 통해 미리 재현성을 확보해야 한다. 그리고 함수 실행 시 시간이 다소 소요된다. 그리고 dummy variable의 경우도 수치형으로 바꿔주어야 함수가 실행된다.

### hidden layer의 개수 2, 각각의 layer에 대한 node의 수 2

```{r}
set.seed(1234)
ann1 <- neuralnet(환기율~외부기온+외부풍속+외부일사량+환기창면적+작물유무수치, data=ex1, hidden=c(2,2), threshold = 0.01, stepmax = 1e+08)
summary(ann1)
```

- 모형적합 결과, 5(입력)-2(은닉)-1(출력) 형태의 신경망 모형이 구성되었다.
- 이 모형을 이용하여 환기율의 예측값을 구하고 이를 바탕으로 예측력의 정확성을 판단하는 기준인 RMSE를 계산하도록 한다. 이는 다음과 같이 계산한다.
- $RMSE = \frac {1} {n} \sqrt {\sum _{i=1} ^{n} (y _{i} - {\hat{y _{i}}} ) ^{2}}$

```{r}
y_hat_ann1 <- compute(ann1, ex1)$net.result
RMSE <- mean(sum((ex1$환기율-y_hat_ann1)^2))
RMSE
```

- 결과적으로 ANN 모형을 적합했을 때 산출되는 RMSE의 값은 $RMSE=190.7235$이다. 

### train:test

- 이제 이 모형에 대한 예측력을 평가하기 위해 train:test=7:3 으로 데이터를 나눈 뒤 train data에 대해 모형을 적합하고 test data를 이용하여 test RMSE를 계산해보도록 한다. 

```{r}
set.seed(5790)
train.index <- sample(1:nrow(ex1), round(nrow(ex1)*7/10), replace=F)
ex1_train <- ex1[train.index,]
ex1_test <- ex1[-train.index,]
```

```{r}
set.seed(1234)
ann1 <- neuralnet(환기율~외부기온+외부풍속+외부일사량+환기창면적+작물유무수치, data=ex1_train, hidden=c(2,2), threshold = 0.01, stepmax = 1e+08)
summary(ann1)
```

- 모형적합 결과, 5(입력)-2(은닉)-1(출력) 형태의 신경망 모형이 구성되었다.
- 이 모형을 이용하여 test data에 대한 환기율의 예측값을 구하고 이를 바탕으로 예측력의 정확성을 판단하는 기준인 test RMSE를 계산하도록 한다. 이는 다음과 같이 계산한다.
- $RMSE = \frac {1} {n} \sqrt {\sum _{i=1} ^{n} (y _{i} - {\hat{y _{i}}} ) ^{2}}$

```{r}
y_hat_ann1 <- compute(ann1, ex1_test)$net.result
RMSE <- mean(sum((ex1_test$환기율-y_hat_ann1)^2))
RMSE
```

- 결과적으로 train data를 이용하여 ANN 모형을 적합하고 이를 이용하여 test data에 대해 계산한 RMSE의 값은 $RMSE=52.31884$이다. 이는 다중선형회귀모형의 경우와 비교하면 작은 값이므로 ANN 모형이 다중선형회귀모형보다 예측력이 더 좋다고 말할 수 있다.


