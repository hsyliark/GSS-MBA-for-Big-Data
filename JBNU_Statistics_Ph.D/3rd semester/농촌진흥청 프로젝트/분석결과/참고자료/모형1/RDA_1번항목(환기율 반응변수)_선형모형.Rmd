---
title: "RDA project"
author: "JBNU statistics"
date: '2021 11 16 '
output: html_document
---

## 목적 : 단동 비닐하우스 환기율 및 온습도에 대한 예측모형 구축 및 평가
## 사용모형 : Multiple Linear Regression Model (반응변수 : 환기율)

## 0. 분석방향

- 환기율을 반응변수로, 외부기온, 외부풍속, 외부일사량, 환기창면적을 독립변수로 하는 선형회귀모형 적합.
- 작물유무에 따라 실험이 수행되었으므로 두 경우에 각각 다른 모형을 적합해보고, 두 데이터세트를 합쳐서 작물유무를 추가 독립변수로 가지는 모형을 또한 적합하여 본다.
- 향후 싫험조건 추가에 따라 작물의 크기를 독립변수로 하는 모형 개발이 가능할 것으로 판단된다.
- 환기율은 외부기온, 외부풍속, 환기창면적 등에 의해 계산되는 값이다. 하지만 그 산식이 비선형적이고 복잡하다. 따라서, 본 모형은 외부일사량과 같은 또다른 요인을 고려하여, 물리적 산식에 대한 선형근사식을 찾는 것으로 이해할 수도 있겠다.
- 고려하는 독립변수들은 모두 어느 정도의 중요도를 가진다고 판단된다. 따라서, 영향력이 큰 변수들을 골라내아 단순화된 모형을 찾는 것이 본 분석의 일차적인 목적은 아닐 수 있다.
- 후술하겠지만, 독립변수들간의 교호작용(혹은 상호작용: interaction effect)의 존재가 어느 정도 확인된다. 하지만 교호작용의 포함은 모형의 해석을 난해하게 만들 수 있다.
- 위 요소들을 종합하여, (1) 가능한 모든 효과를 포함한 모형 (2) 예측성능 혹은 변수선택측도 등의 차원에서 가장 우수한 모형 (3) 모든 독립변수들의 주효과를 포함하되 교호작용은 최소한으로 포함한 모형, 크게 3개의 차원에서 모형을 살펴보고 그 예측성능 및 설명력 등을 비교하여 보겠다.

## 1. Loading data

- 작물있음 데이터에서 외부CO2의 값이 결측치인 경우는 제외하였음.

```{r}
setwd("D:/OneDrive - 전북대학교/전북대학교/농림과학원용역/2021")
plantyes <- read.csv("작물있음.csv",sep=",",header=T)
plantyes <- plantyes[is.na(plantyes$외부CO2)==FALSE,]
head(plantyes,10)
plantyes$작물유무 <- as.factor(plantyes$작물유무)
plantno <- read.csv("작물없음.csv",sep=",",header=T)
head(plantno,10) 
plantno$작물유무 <- as.factor(plantno$작물유무)
plant <- rbind(plantno,plantyes)
```


## 2. 작물유무에 따라 데이터를 나누어서 분석 실시

### 2.1 작물이 없을 떄

#### Multiple Linear Regression Model

- 먼저 변수들 간의 상관관계를 파악하기 위해 상관분석을 실시한다.

```{r}
ex1 <- plantno[,c(12,1,10,11,13,14,15)]
head(ex1)
ex2 <- ex1[,1:5]
```

```{r}
cor( ex2)
```

- 분석결과, pearson 표본상관계수에 따르면 환기창면적과 외부풍속, 환기창면적과 외부일사량은 음의 상관관계를 보이고 있으며, 나머지는 모두 양의 상관관계를 보이고 있다. 이에 대해 산점도행렬과 상관계수그림을 그리면 다음과 같다.

```{r}
pairs(ex2[1:nrow(plantno),],col=factor(ex2$환기창면적))
```

- 산점도를 통해 알 수 있는 사실은 환기창면적과 외부풍속과의 상호작용(interaction)이 명백하게 존재할 것이라는 것이다. 그 상호작용을 고려한다면 선형모형만으로도 상당히 높은 설명력과 정확한 예측력이 나타날 것으로 생각된다. 외부기온과 외부일사량에 대해서는 환기창면적과의 상호작용은 없거나 강하지 않을 것으로 판단되어 상황에 따라 모형에 포함시키거나 뺄 수 있을 것이다.

```{r}
library(corrplot)
corrplot(cor(ex2))
```

- 그리고 각 변수에 대한 기초통계량은 다음과 같이 계산된다.

```{r}
library(psych)
describe(ex1[,c(-6,-7)])
```

- 환기율을 반응변수로 하여 각 변수의 주효과와, 환기창면적과의 교호작용을 고려한 다중선형회귀모형을 적합하면 다음과 같다.

```{r}
m_no <- lm(환기율~외부기온+외부풍속+외부일사량+환기창면적+환기창면적*외부기온+환기창면적*외부풍속+환기창면적*외부일사량,data=plantno)
summary(m_no)
```

- 모형적합 결과 외부기온, 외부일사량은 유의수준 0.05에서 유의미하지 않다. 외부풍속과 환기창면적과의 교호작용은 예상한대로 유의미하였고, 외부일사량과 환기창면적과의 교호작용도 유의미한 것으로 나타나기는 하였다. 조정된 결정계수의 값이 $R^2_{adj}=0.9959$이므로 이 모형은 데이터의 변동을 거의 완벽하게 설명하고 있는 것으로 보인다.

#### Best subset selection

- 여러 측도들을 이용하여 모형에 포함될 변수를 적절히 선택해 보도록 하겠다. 
- 고려하는 가장 큰 모형 (full model)은 각 독립변수의 주효과와 환기창면적과 다른 독립변수들과의 교호작용을 포함한 모형이다. 
- 이는, 환기창면적에 따라서 다른 독립변수들이 환기율에 미치는 영향이 달라질 수 있을 것이라는 생각으로부터 고려된 것이다. 다른 변수들에 의한 교호작용은 산점도 상에서 뚜렷하게 확인되지 않는 것으로 보인다. 
- 여러 모형선택의 측도에 따라 몇개의 효과 (그리고 어떤 효과들) 를 포함한 모형이 더 나을지를 1차적으로 판단하기 위한 절차이다. 

```{r}
library(leaps)
ms0 <- regsubsets(환기율~외부기온+외부풍속+외부일사량+환기창면적+환기창면적*외부기온+환기창면적*외부풍속+환기창면적*외부일사량,data=plantno,
                     nvmax=7)
ms0.summary <- summary(ms0)
ms0.summary

par(mfrow=c(2,2)) 
# RSS=SSE
plot(ms0.summary$rss,xlab="Number of Variables",ylab="RSS",type="l")
# Adj R^2
plot(ms0.summary$adjr2,xlab="Number of Variables",ylab="Adjusted RSq",type="l")
which.max(ms0.summary$adjr2)
points(which.max(ms0.summary$adjr2)
,ms0.summary$adjr2[which.max(ms0.summary$adjr2)
], col="red",cex=2,pch=20)
# Cp
plot(ms0.summary$cp,xlab="Number of Variables",ylab="Cp",type='l') 
which.min(ms0.summary$cp)
points(which.min(ms0.summary$cp)
,ms0.summary$cp[which.min(ms0.summary$cp)
],col="red",cex=2,pch=20)
# BIC
plot(ms0.summary$bic,xlab="Number of Variables",ylab="BIC",type='l')
which.min(ms0.summary$bic) 
points(which.min(ms0.summary$bic) 
,ms0.summary$bic[which.min(ms0.summary$bic) 
],col="red",cex=2,pch=20)
```

- Best subset selection의 결과를 보면 설명변수의 개수에 따라 어떤 변수를 넣는것이 바람직한지를 제시하고 있다. 바람직한 설명변수의 개수를 선택하는 데 있어 기준이 되는 통계량 중 $RSS$, $R^2_{adj}$, $C_{p}$, $BIC$를 기준으로 몇개의 설명변수를 선택하는 것이 바람직한지를 살펴보면 위와 같다.
- 위의 결과를 보면 $R^2_{adj}$ 기준으로는 모든 효과를 포함시키는 모형, $C_{p}$, $BIC$ 기준으로는 4개의 설명변수를 선택하는 것이 가장 바람직하다는 결과를 주고 있다. 이 4개의 변수는 외부풍속, 환기창면적, 외부풍속/외부일사량과 환기창면적과의 교호작용이다. 교호작용이 모형에 포함될 때 주효과도 함께 포함하는 것이 보통 자연스러우므로, 결과적으로  외부풍속, 환기창면적, 외부일사량, 외부풍속$\times$환기창면적, 외부일사량$\times$환기창면적 ($\times$는 교호작용을 나타냄.)을 포함한 모형이 비교적 간단하면서 좋은 모형일 수 있겠다.

#### 교차타당검증에 의한 모형 비교 

- 지금부터는 train:test=7:3 으로 데이터를 나누어서 몇 개의 후보 모형들의 test RMSE (Residual Mean Squared Error)를 계산하여 보겠다. 이 값이 작을수록 예측력이 우수한 모형이라고 볼 수 있다.
- 먼저 데이터를 임의로 train:test=7:3 의 비율로 나눈다. train data는 모형구축 시, test data는 구축된 모형을 평가 시 사용한다.
- 비교 대상이 되는 모형은 독립변수 기준으로 다음을 포함하는 모형들이다.
    - (1) (가장 큰 모형) 외부기온, 외부풍속, 외부일사량, 환기창면적, 외부기온$\times$환기창면적, 외부풍속$\times$환기창면적, 외부일사량$\times$환기창면적
    - (2) (위에서 선택된 모형) 외부풍속, 외부일사량, 환기창면적, 외부풍속$\times$환기창면적, 외부일사량$\times$환기창면적
    - (3) (주효과에 교호작용 한개만 포함된 모형) 외부기온, 외부풍속, 외부일사량, 환기창면적, 외부풍속$\times$환기창면적


```{r}
# 데이터 분할
set.seed(5790)
train.index <- sample(1:nrow(plantno), round(nrow(plantno)*7/10), replace=F)
ex1_train <- plantno[train.index,]
ex1_test <- plantno[-train.index,]
```

```{r}

m0 <- lm(환기율~외부기온+외부풍속+외부일사량+환기창면적+환기창면적*외부기온+환기창면적*외부풍속+환기창면적*외부일사량,data=ex1_train) 
y_hat0 <- predict(m0,ex1_test)
RMSE0 <- mean(sum((ex1_test$환기율-y_hat0)^2))
RMSE0


m1 <- lm(환기율~외부풍속+외부일사량+환기창면적+환기창면적*외부풍속+환기창면적*외부일사량,data=ex1_train) 
y_hat1 <- predict(m1,ex1_test)
RMSE1 <- mean(sum((ex1_test$환기율-y_hat1)^2))
RMSE1


m2 <- lm(환기율~외부기온+외부풍속+외부일사량+환기창면적+환기창면적*외부풍속,data=ex1_train) 
y_hat2 <- predict(m2,ex1_test)
RMSE2 <- mean(sum((ex1_test$환기율-y_hat2)^2))
RMSE2
```

- 결과적으로 3가지 모형들 중 환기창면적과 외부풍속 외부일사량 주효과와, 환기창면적과 외부풍속/외부일사량과의 교호작용을 포함한 모형이 가장 우수하였다. 
- 그러나 전체적으로 모형들의 예측력이 매우 우수한 편이다. 참고로, test RMSE 산출시 사용된 데이터가 약 230개 가량인데 잔차제곱합이 2.3 수준이므로 거의 완벽한 예측이 이루어지고 있다. 

- 아래는 세 모형에 대한 데이터 전체 적합결과이다.

#### 외부기온, 외부풍속, 외부일사량, 환기창면적, 외부기온$\times$환기창면적, 외부풍속$\times$환기창면적, 외부일사량$\times$환기창면적 모형

```{r}
summary(lm(환기율~외부기온+외부풍속+외부일사량+환기창면적+환기창면적*외부기온+환기창면적*외부풍속+환기창면적*외부일사량,data=plantno))
```

- ${\hat{y}} = -0.3293 + 0.0059x_{1} + 0.0806x_{2} - 0.00007x_{3} + 9.1540x_{4} -  0.0618x_{1}x_{4} + 7.3700x_{2}x_{4} + 0.0045x_{3}x_{4}$
- $y$ : 환기율, $x _{1}$ : 외부기온, $x _{2}$ : 외부풍속, $x _{3}$ : 외부일사량, $x_{4}$ : 환기창면적
- 수정결정계수는 0.9959

#### 외부풍속, 외부일사량, 환기창면적, 외부풍속$\times$환기창면적, 외부일사량$\times$환기창면적 모형

```{r}
summary(lm(환기율~외부풍속+외부일사량+환기창면적+환기창면적*외부풍속+환기창면적*외부일사량,data=plantno))
```

- ${\hat{y}} = -0.2147 +  0.0843x_{2} - 0.00005x_{3} + 7.9600x_{4} + 7.3320x_{2}x_{4} + 0.0043x_{3}x_{4}$
- $y$ : 환기율, $x _{2}$ : 외부풍속, $x _{3}$ : 외부일사량, $x_{4}$ : 환기창면적
- 수정결정계수는 0.9959


#### 외부기온, 외부풍속, 외부일사량, 환기창면적, 외부풍속$\times$환기창면적 모형

```{r}
summary(lm(환기율~외부기온+외부풍속+외부일사량+환기창면적+환기창면적*외부풍속,data=plantno))
```

- ${\hat{y}} = -0.4360 + 0.0002x_{1} + 0.0812x_{2} - 0.0004x_{3} + 10.3000x_{4} + 7.3640x_{2}x_{4}$
- $y$ : 환기율, $x _{1}$ : 외부기온, $x _{2}$ : 외부풍속, $x _{3}$ : 외부일사량, $x_{4}$ : 환기창면적
- 수정결정계수는 0.9955

#### 해석
- 세 모형 모두 높은 설명력을 보인다. 
- 외부기온, 외부풍속, 환기창면적은 양의 계수를 가지므로 커질 수록 환기율이 높아지는 경향이 있다. 단, 외부일사량의 경우는 모향에 따라 연관성의 방향이 바뀌기도 하였으나 모형 내에서 영향력이 그리 크지는 않았다.
- 외부풍속과 환기창면적 사이의 교호작용을 중요한 영향력을 가지는 것으로 평가되며, 교호작용 항의 계수가 양수이다. 즉, 환기창 면적이 클 수록 외부풍속의 증가는 환기율의 더 급속한 증가를 가져온다고 해석할 수 있다.

### 2.2 작물이 있을 떄

#### Multiple Linear Regression Model

- 먼저 변수들 간의 상관관계를 파악하기 위해 상관분석을 실시한다.

```{r}
ex1 <- plantyes[,c(12,1,10,11,13,14,15)]
head(ex1)
ex2 <- ex1[,1:5]
```

```{r}
cor(ex2)
```

- 분석결과, 작물이 없을 떄와 유사한 패턴이 있다. 

```{r}
pairs(ex2[1:nrow(plantyes),],col=factor(ex2$환기창면적))
```

- 외부풍속과 환기창 면적의 교호작용이 존재할 것으로 예상되나 작물이 없을 떄에 비하면 강하지 않아 보인다.
- 작물이 없을 때와 비교할 때 noise level이 조금 높은 것으로 보인다. 즉, 모형의 설명력이 상대적으로 저하되리라고 생각된다.

```{r}
library(corrplot)
corrplot(cor(ex2))
```

- 그리고 각 변수에 대한 기초통계량은 다음과 같이 계산된다. 

```{r}
library(psych)
describe(ex1[,c(-6,-7)])
```

- 환기율을 반응변수로 하여 각 변수의 주효과와, 환기창면적과의 교호작용을 고려한 다중선형회귀모형을 적합하면 다음과 같다.

```{r}
m_yes <- lm(환기율~외부기온+외부풍속+외부일사량+환기창면적+환기창면적*외부기온+환기창면적*외부풍속+환기창면적*외부일사량,data=plantyes)
summary(m_yes)
```

- 모형적합 결과 모든 변수가 유의수준 0.05에서 유의미하였다. 조정된 결정계수의 값이 $R^2_{adj}=0.9817$이므로 작물이 없을 때보다는 약하지만 설명력이 매우 높은 수준이다.

#### Best subset selection

- 여러 측도들을 이용하여 모형에 포함될 변수를 적절히 선택해 보도록 하겠다.
- 전반적인 방향은 작물이 없을 때와 같다. 

```{r}
library(leaps)
ms0 <- regsubsets(환기율~외부기온+외부풍속+외부일사량+환기창면적+환기창면적*외부기온+환기창면적*외부풍속+환기창면적*외부일사량,data=plantyes,
                     nvmax=7)
ms0.summary <- summary(ms0)
ms0.summary

par(mfrow=c(2,2)) 
# RSS=SSE
plot(ms0.summary$rss,xlab="Number of Variables",ylab="RSS",type="l")
# Adj R^2
plot(ms0.summary$adjr2,xlab="Number of Variables",ylab="Adjusted RSq",type="l")
which.max(ms0.summary$adjr2)
points(which.max(ms0.summary$adjr2)
,ms0.summary$adjr2[which.max(ms0.summary$adjr2)
], col="red",cex=2,pch=20)
# Cp
plot(ms0.summary$cp,xlab="Number of Variables",ylab="Cp",type='l') 
which.min(ms0.summary$cp)
points(which.min(ms0.summary$cp)
,ms0.summary$cp[which.min(ms0.summary$cp)
],col="red",cex=2,pch=20)
# BIC
plot(ms0.summary$bic,xlab="Number of Variables",ylab="BIC",type='l')
which.min(ms0.summary$bic) 
points(which.min(ms0.summary$bic) 
,ms0.summary$bic[which.min(ms0.summary$bic) 
],col="red",cex=2,pch=20)
```

- Best subset selection의 결과를 보면 설명변수의 개수에 따라 어떤 변수를 넣는것이 바람직한지를 제시하고 있다. 바람직한 설명변수의 개수를 선택하는 데 있어 기준이 되는 통계량 중 $RSS$, $R^2_{adj}$, $C_{p}$, $BIC$를 기준으로 몇개의 설명변수를 선택하는 것이 바람직한지를 살펴보면 위와 같다.
- 모든 변수를 포함시키는 것이 좋다는 결론이 우세하다. BIC 기준으로는 외부풍속 주효과를 제거하는 것이 좋다고 나오는데 외부풍속은 중요한 요소이므로 빼지 않는 것이 좋아 보인다. 
- 하지만, 측도들이 변수 3개 이상에서 안정화되는 경향이 있어 모형의 단순화를 위해서는 3개 예측변수만을 포함하는 모형도 나쁘지 않아 보인다. 이는 외부일사량, 환기창면적, 외부풍속과 환기창면적과의 교호작용을 포함하는 모형이다. 외부풍속의 주효과도 추가적으로 고려한다.  

#### 교차타당검증에 의한 모형 비교 

- 지금부터는 train:test=7:3 으로 데이터를 나누어서 몇 개의 후보 모형들의 test RMSE를 계산하여 보겠다. 이 값이 작을수록 예측력이 우수한 모형이라고 볼 수 있다.
- 먼저 데이터를 임의로 train:test=7:3 의 비율로 나눈다. train data는 모형구축 시, test data는 구축된 모형을 평가 시 사용한다.
- 비교 대상이 되는 모형은 독립변수 기준으로 다음을 포함하는 모형들이다.
    - (1) (가장 큰 모형) 외부기온, 외부풍속, 외부일사량, 환기창면적, 외부기온$\times$환기창면적, 외부풍속$\times$환기창면적, 외부일사량$\times$환기창면적
    - (2) (약간의 단순화를 고려한 모형) 외부풍속, 외부일사량, 환기창면적, 외부풍속$\times$환기창면적
    - (3) (주효과에 교호작용 한개만 포함된 모형) 외부기온, 외부풍속, 외부일사량, 환기창면적, 외부풍속$\times$환기창면적


```{r}
set.seed(5790)
train.index <- sample(1:nrow(plantyes), round(nrow(plantyes)*7/10), replace=F)
ex1_train <- plantyes[train.index,]
ex1_test <- plantyes[-train.index,]
```

```{r}
m0 <- lm(환기율~외부기온+외부풍속+외부일사량+환기창면적+환기창면적*외부기온+환기창면적*외부풍속+환기창면적*외부일사량,data=ex1_train) 
y_hat0 <- predict(m0,ex1_test)
RMSE0 <- mean(sum((ex1_test$환기율-y_hat0)^2))
RMSE0

m1 <- lm(환기율~외부풍속+외부일사량+환기창면적+환기창면적*외부풍속,data=ex1_train) 
y_hat1 <- predict(m1,ex1_test)
RMSE1 <- mean(sum((ex1_test$환기율-y_hat1)^2))
RMSE1

m2 <- lm(환기율~외부기온+외부풍속+외부일사량+환기창면적+환기창면적*외부풍속,data=ex1_train) 
y_hat2 <- predict(m2,ex1_test)
RMSE2 <- mean(sum((ex1_test$환기율-y_hat2)^2))
RMSE2
```

- 결과적으로 3가지 모형들 중 모든 변수가 포함된 모형이 가장 우수하였다. 
- 하지만 test RMSE상의 차이가 매우 작았다. 따라서, 더 간단한 모형을 선택하는 것도 좋을 것으로 판단된다.
- 작물이 없을 떄와 비교하면 상대적으로 test RMSE값이 크지만 여전히 매우 정확예 예측력을 보인다. 

#### 외부기온, 외부풍속, 외부일사량, 환기창면적, 외부기온$\times$환기창면적, 외부풍속$\times$환기창면적, 외부일사량$\times$환기창면적 모형

```{r}
summary(lm(환기율~외부기온+외부풍속+외부일사량+환기창면적+환기창면적*외부기온+환기창면적*외부풍속+환기창면적*외부일사량,data=plantyes))
```

- ${\hat{y}} = -3.5365  + 0.1038x_{1} + -0.1265x_{2} + 41.5686x_{3} + 0.0006x_{4} -0.9017x_{3}x_{1} + 14.5193x_{2}x_{3} + 0.0077x_{3}x_{4}$
- $y$ : 환기율, $x _{1}$ : 외부기온, $x _{2}$ : 외부풍속, $x_{3}$ : 환기창면적, $x _{4}$ : 외부일사량
- 수정결정계수는 0.9817

#### 외부풍속, 외부일사량, 환기창면적, 외부풍속$\times$환기창면적 모형

```{r}
summary(lm(환기율~외부풍속+외부일사량+환기창면적+환기창면적*외부풍속,data=plantyes) )
```


- ${\hat{y}} = -1.1980 - 0.0989x_{2} + 21.0200x_{3} + 0.0016x_{4}+14.3600x_{2}x_{3}$
- $y$ : 환기율, $x _{2}$ : 외부풍속, $x_{3}$ : 환기창면적, $x _{4}$ : 외부일사량
- 수정결정계수는 0.9806

#### 외부기온, 외부풍속, 외부일사량, 환기창면적, 외부풍속$\times$환기창면적 모형

```{r}
summary(lm(환기율~외부기온+외부풍속+외부일사량 + 환기창면적+환기창면적*외부풍속,data=plantyes) )
```


- ${\hat{y}} = -0.9642 - 0.0109x_{1} - 0.0727x_{2} + 21.1900x_{3}+0.0016x_{4}+14.2100x_{2}x_{3}$
- $y$ : 환기율, $x _{1}$ : 외부기온,  $x _{2}$ : 외부풍속, $x_{3}$ : 환기창면적, $x _{4}$ : 외부일사량
- 수정결정계수는 0.9807


#### 해석
- 세 모형 모두 높은 설명력을 보인다. 
- 외부풍속과 환기창면적 사이의 교호작용을 중요한 영향력을 가지는 것으로 평가되며, 교호작용 항의 계수가 양수이다. 즉, 환기창 면적이 클 수록 외부풍속의 증가는 환기율의 더 급속한 증가를 가져온다고 해석할 수 있다.



### 2.3 작물유무 데이터를 합쳤을 때

#### Multiple Linear Regression Model

- 상관분석 등의 절차는 앞서 데이터를 나누어 각각 수행하였으므로 생략한다. 
- 환기율을 반응변수로 하여 기존 독립변수들에 작물유무를 나타내는 변수를 추가하여 고려한다.
- 작물유무에 따라 데이터세트를 나누어서 선형모형을 적합한 결과로부터, 두 적합모형은 형태가 약간 다르다. 이는 작물유무와 다른 독립변수들과의 교호작용의 존재 가능성을 함축한다. 
- 너무 많은 교호작용을 포함하는 것은 모형을 지나치게 복잡하게 만들 수 있다. 앞서서 적합한 여러 모형들을 살펴보면 교호작용들 중 외부풍속과 환기창면적 사이의 효과만 고려한 모형도 test RMSE와 설명력의 관점에서 충분히 우수하고 경쟁력이 있었다.
- 따라서, 외부기온, 외부풍속, 외부일사량, 환기창면적, 외부풍속$\times$환기창면적이 포함된 모형을 기본으로 이들과 작물유무 및 작물유무와의 교호작용을 고려한 모형을 시작점으로 삼도록 하겠다. 단, 세 변수 이상의 교호작용은 단순성을 위해 고려하지 않는다. 아래는 해당모형의 적합결과이다. 

```{r}
m0 <- lm(환기율~외부기온+외부풍속+외부일사량+환기창면적+작물유무+
              외부기온*작물유무+외부풍속*작물유무+외부일사량*작물유무+환기창면적*작물유무+외부풍속*환기창면적,data=plant)
summary(m0)
```

- 조정된 결정계수의 값이 $R^2_{adj}=0.9846$이므로 설명력이 매우 높은 수준이다.

#### Best subset selection

- 여러 측도들을 이용하여 모형에 포함될 변수를 적절히 선택해 보도록 하겠다.
- 전반적인 방향은 작물이 없을 때와 같다. 

```{r}
library(leaps)
ms0 <- regsubsets(환기율~외부기온+외부풍속+외부일사량+환기창면적+작물유무+
              외부기온*작물유무+외부풍속*작물유무+외부일사량*작물유무+환기창면적*작물유무+외부풍속*환기창면적,data=plant,
                     nvmax=10)
ms0.summary <- summary(ms0)
ms0.summary

par(mfrow=c(2,2)) 
# RSS=SSE
plot(ms0.summary$rss,xlab="Number of Variables",ylab="RSS",type="l")
# Adj R^2
plot(ms0.summary$adjr2,xlab="Number of Variables",ylab="Adjusted RSq",type="l")
which.max(ms0.summary$adjr2)
points(which.max(ms0.summary$adjr2)
,ms0.summary$adjr2[which.max(ms0.summary$adjr2)
], col="red",cex=2,pch=20)
# Cp
plot(ms0.summary$cp,xlab="Number of Variables",ylab="Cp",type='l') 
which.min(ms0.summary$cp)
points(which.min(ms0.summary$cp)
,ms0.summary$cp[which.min(ms0.summary$cp)
],col="red",cex=2,pch=20)
# BIC
plot(ms0.summary$bic,xlab="Number of Variables",ylab="BIC",type='l')
which.min(ms0.summary$bic) 
points(which.min(ms0.summary$bic) 
,ms0.summary$bic[which.min(ms0.summary$bic) 
],col="red",cex=2,pch=20)
```

- Best subset selection의 결과를 보면 설명변수의 개수에 따라 어떤 변수를 넣는것이 바람직한지를 제시하고 있다. 바람직한 설명변수의 개수를 선택하는 데 있어 기준이 되는 통계량 중 $RSS$, $R^2_{adj}$, $C_{p}$, $BIC$를 기준으로 몇개의 설명변수를 선택하는 것이 바람직한지를 살펴보면 위와 같다.
- 외부기온을 제거하는 모형을 선택하고 있다. 한편, 외부기온과 작물유무와의 교호작용도 제거될 수 있는 효과 중 하나로 보인다. 
- 교호작용 효과들도 대부분 모형에서 중요한 것으로 보인다. 하지만 이 효과는 모형의 해석을 매우 복잡하게 만들 수 있으므로 꼭 포함시키는 것이 필요할지 검토가 필요하다.   

#### 교차타당검증에 의한 모형 비교 

- 지금부터는 train:test=7:3 으로 데이터를 나누어서 몇 개의 후보 모형들의 test RMSE를 계산하여 보겠다. 이 값이 작을수록 예측력이 우수한 모형이라고 볼 수 있다.
- 먼저 데이터를 임의로 train:test=7:3 의 비율로 나눈다. train data는 모형구축 시, test data는 구축된 모형을 평가 시 사용한다.
- 비교 대상이 되는 모형은 독립변수 기준으로 다음을 포함하는 모형들이다.
    - (1) (가장 큰 모형) 외부기온, 외부풍속, 외부일사량, 환기창면적, 작물유무, 외부기온$\times$작물유무, 외부풍속$\times$작물유무, 외부일사량$\times$작물유무, 환기창면적$\times$작물유무, 환기창면적$\times$작물유무, 외부풍속$\times$환기창면적
    - (2) (외부기온에 의한 효과를 제거하여 약간의 단순화를 고려한 모형)  외부풍속, 외부일사량, 환기창면적, 작물유무, 외부풍속$\times$작물유무, 외부일사량$\times$작물유무, 환기창면적$\times$작물유무, 외부풍속$\times$환기창면적
    - (3) (주효과는 모두 포함하되 외부기온, 외부일사량의 교호작용 제거한 모형 )  외부기온, 외부풍속, 외부일사량, 환기창면적, 작물유무, 외부풍속$\times$작물유무,  환기창면적$\times$외부풍속, 환기창면적$\times$작물유무
 

```{r}
set.seed(5790)
train.index <- sample(1:nrow(plant), round(nrow(plant)*7/10), replace=F)
ex1_train <- plant[train.index,]
ex1_test <- plant[-train.index,]
```

```{r}
m0 <- lm(환기율~외부기온+외부풍속+외부일사량+환기창면적+작물유무+
              외부기온*작물유무+외부풍속*작물유무+외부일사량*작물유무+환기창면적*작물유무+환기창면적:외부풍속,data=ex1_train) 
y_hat0 <- predict(m0,ex1_test)
RMSE0 <- mean(sum((ex1_test$환기율-y_hat0)^2))
RMSE0

m1 <- lm(환기율~외부풍속+외부일사량+환기창면적+작물유무+
              외부풍속*작물유무+외부일사량*작물유무+환기창면적*작물유무+환기창면적:외부풍속,data=ex1_train) 
y_hat1 <- predict(m1,ex1_test)
RMSE1 <- mean(sum((ex1_test$환기율-y_hat1)^2))
RMSE1

m3 <- lm(환기율~외부기온+외부풍속+외부일사량+환기창면적+작물유무+
              외부풍속*작물유무+환기창면적*작물유무+환기창면적*외부풍속,data=ex1_train) 
y_hat3 <- predict(m3,ex1_test)
RMSE3 <- mean(sum((ex1_test$환기율-y_hat3)^2))
RMSE3
```

- 모든 효과를 포함한 모형이 가장 우수하였다 
- 일부 교호작용을 제거하여 단순화하여도 충분히 좋은 성능을 보인다. 

#### 외부기온, 외부풍속, 외부일사량, 환기창면적, 작물유무, 외부기온$\times$작물유무, 외부풍속$\times$작물유무, 외부일사량$\times$작물유무, 환기창면적$\times$작물유무, 외부풍속$\times$환기창면적 모형

```{r}
summary(lm(환기율~외부기온+외부풍속+외부일사량+환기창면적+작물유무+
              외부기온*작물유무+외부풍속*작물유무+외부일사량*작물유무+환기창면적*작물유무+환기창면적:외부풍속,data=plant))
```


- 수정결정계수는 0.9846

#### 외부풍속, 외부일사량, 환기창면적, 작물유무, 외부풍속$\times$작물유무, 외부일사량$\times$작물유무, 환기창면적$\times$작물유무, 환기창면적$\times$작물유무, 외부풍속$\times$환기창면적 모형

```{r}
summary(lm(환기율~외부풍속+외부일사량+환기창면적+작물유무+
              외부풍속*작물유무+외부일사량*작물유무+환기창면적*작물유무+환기창면적:외부풍속,data=plant) )
```

- 수정결정계수는 0.9844

#### 외부기온, 외부풍속, 외부일사량, 환기창면적, 작물유무, 외부풍속$\times$작물유무,  환기창면적$\times$외부풍속, 환기창면적$\times$작물유무 모형

```{r}
summary(lm(환기율~외부기온+외부풍속+외부일사량+환기창면적+작물유무+
              외부풍속*작물유무+환기창면적*작물유무+환기창면적*외부풍속,data=plant) )
```


- 수정결정계수는 0.9828


#### 해석
- 세 모형 모두 높은 설명력을 보인다. 
- 모형의 단순함을 위해서는 세번째 모형을 고려하는 것도 좋아 보인다. 적합된 모형은 다음과 같다. 
    - ${\hat{y}} = -0.0422 - 0.0105x_{1} - 0.1516x_{2} + 3.5270x_{3}+0.0012x_{4}-1.7710x_{5}+10.7030x_{2}x_{5}+25.0400x_{3}x_{5}+9.8640x_{2}x_{3}$
    - $y$ : 환기율, $x _{1}$ : 외부기온,  $x _{2}$ : 외부풍속, $x_{3}$ : 환기창면적, $x _{4}$ : 외부일사량, $x _{5}$ : 작물유무 (작물있음=1, 작물없음=0)
- 본문에는 포함하지 않았지만 test 결과 추가로 모형의 단순화를 원한다면, 외부풍속$\times$작물유무, 환기창면적$\times$외부풍속, 환기창면적$\times$작물유무 순으로 교호작용을 제거하는 것이 좋다. 


