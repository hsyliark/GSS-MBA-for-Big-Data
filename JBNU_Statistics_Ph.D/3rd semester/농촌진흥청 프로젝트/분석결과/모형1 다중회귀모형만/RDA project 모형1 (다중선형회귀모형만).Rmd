---
title: "RDA project (211004)"
author: "Hwang Seong-Yun"
date: '2021 11 4 '
output: html_document
---

# 농촌진흥청 프로젝트

## 목적 : 단동 비닐하우스 환기율 및 온습도에 대한 예측모형 구축 및 평가
## 사용모형 : Multiple Linear Regression Model v.s Artificial Neural Network Model (ANN)

### Loading data

- 작물있음 데이터에서 외부CO2의 값이 결측치인 경우는 제외하였음.

```{r}
plantyes <- read.csv("C:/Users/HSY/Desktop/작물있음.csv",sep=",",header=T)
plantyes <- plantyes[is.na(plantyes$외부CO2)==FALSE,]
head(plantyes,10)
plantyes$작물유무 <- as.factor(plantyes$작물유무)
plantno <- read.csv("C:/Users/HSY/Desktop/작물없음.csv",sep=",",header=T)
head(plantno,10) 
plantno$작물유무 <- as.factor(plantno$작물유무)
plant <- rbind(plantyes,plantno)
```

### Open library

```{r}
library(nnet)
library(devtools)
library(neuralnet)
library(NeuralNetTools)
```

- 작물유무에 따라 데이터를 나누어서 사전분석을 실시한 결과 구축된 모형에 많은 차이가 있었다. 이에 따라 작물있음 데이터와 작물없음 데이터를 합친 데이터에 대해 작물유무와 다른 독립변수들간의 교호작용을 포함한 모형을 적합하여 결과를 살펴보았다.



# 1. 환기율 ~ 외부기온, 외부풍속, 외부일사량, 환기창면적, 작물유무

# 작물이 있는 경우

## Multiple Linear Regression Model

- 먼저 변수들 간의 상관관계를 파악하기 위해 상관분석을 실시한다.

```{r}
ex1 <- plantyes[,c(12,1,10,11,13)]
head(ex1)
```

```{r}
cor(ex1)
```

- 분석결과, pearson 표본상관계수에 따르면 환기창면적과 외부기온, 환기창면적과 외부일사량은 서로 약한 음의 상관관계를 보이고 있으며, 나머지는 모두 양의 상관관계를 보이고 있다. 이를 그림으로 그리면 다음과 같다.

```{r}
library(corrplot)
corrplot(cor(ex1))
```

- 그리고 각 변수에 대한 기초통계량은 다음과 같이 계산된다. 이 결과에 의하면 5가지 변수들 중 외부일사량이 가장 변동이 크다고 할 수 있다.

```{r}
library(psych)
describe(ex1)
```

- 모형을 적합하기 전 주어진 데이터를 임의로 train:test=7:3으로 나누어서 train data를 가지고 적절한 모형을 적합하고 이 모형을 test data를 이용하여 평가할 것이다. 이는 ANN을 적용하는 경우에도 마찬가지이다.

```{r}
set.seed(5790)
train.index <- sample(1:nrow(ex1), round(nrow(ex1)*7/10), replace=F)
ex1_train <- ex1[train.index,]
ex1_test <- ex1[-train.index,]
```

- train data에 대해 다중선형회귀모형을 다음과 같이 적합할 수 있다.

```{r}
m0 <- lm(환기율~외부기온+외부풍속+외부일사량+환기창면적,
            data=ex1_train)
summary(m0)
```

- 모형적합 결과 외부기온, 외부풍속, 외부일사량, 환기창면적 모두 환기율에 유의미한 영향을 미치고 있다고 보여진다. 그리고 조절된 결정계수의 값이 $R^2_{adj}=0.9533$이므로 이 모형이 데이터의 변동을 약 $95%$ 정도 설명하고 있으므로 설명력도 크다는 것을 알 수 있다. 따라서 더이상의 변수선택과정은 필요없을 것으로 판단되며 이에 따라 최종적인 모형식을 다음과 같이 표현할 수 있겠다.
- ${\hat{y}} = -3.5600 - 0.0393x_{1} + 1.9896x_{2} + 0.0015x_{3} + 45.2233x_{4}$
- $y$ : 환기율, $x _{1}$ : 외부기온, $x _{2}$ : 외부풍속, $x_{3}$ : 외부일사량, $x_{4}$ : 환기창면적 
- 이 모형을 이용하여 test data에 대한 환기율의 예측값을 구하고 이를 바탕으로 예측력의 정확성을 판단하는 기준인 RMSE를 계산하도록 한다. 이는 다음과 같이 계산한다.
- $RMSE = \frac {1} {n} \sqrt {\sum _{i=1} ^{n} (y _{i} - {\hat{y _{i}}} ) ^{2}}$

```{r}
y_hat <- predict(m0,ex1_test)
RMSE <- mean(sum((ex1_test$환기율-y_hat)^2))
RMSE
```

- 결과적으로 작물이 있는 경우 다중선형회귀모형을 적합했을 때 산출되는 RMSE는 $RMSE=130.8861$이다.



# 작물이 없는 경우

- 작물이 있는 경우와 동일한 과정으로 분석을 실시한다.

## Multiple Linear Regression Model

- 먼저 변수들 간의 상관관계를 파악하기 위해 상관분석을 실시한다.

```{r}
ex2 <- plantno[,c(12,1,10,11,13)]
head(ex2)
```

```{r}
cor(ex2)
```

- 분석결과, pearson 표본상관계수에 따르면 환기창면적과 외부기온, 환기창면적과 외부일사량은 약한 음의 상관관계를 보이고 있으며, 나머지는 모두 양의 상관관계를 보이고 있다. 이를 그림으로 그리면 다음과 같다.

```{r}
corrplot(cor(ex2))
```

- 그리고 각 변수에 대한 기초통계량은 다음과 같이 계산된다. 이 결과에 의하면 5가지 변수들 중 외부일사량이 가장 변동이 크다고 할 수 있다.

```{r}
describe(ex2)
```

- 모형을 적합하기 전 주어진 데이터를 임의로 train:test=7:3으로 나누어서 train data를 가지고 적절한 모형을 적합하고 이 모형을 test data를 이용하여 평가할 것이다. 이는 ANN을 적용하는 경우에도 마찬가지이다.

```{r}
set.seed(5790)
train.index <- sample(1:nrow(ex2), round(nrow(ex2)*7/10), replace=F)
ex2_train <- ex2[train.index,]
ex2_test <- ex2[-train.index,]
```

- train data에 대해 다중선형회귀모형을 다음과 같이 적합할 수 있다.

```{r}
m0 <- lm(환기율~외부기온+외부풍속+외부일사량+환기창면적,data=ex2_train)
summary(m0)
```

- 모형적합 결과 외부풍속, 외부일사량, 환기창면적 모두 환기율에 유의미한 영향을 미치고 있지만, 외부기온은 유의미한 영향력이 없음을 알 수 있다. 이에 따라 stepwise selection을 통해 적절한 변수를 선택하는 과정이 필요하다고 판단된다.

```{r}
m1 <- step(m0)
summary(m1)
```

- stepwise selection에 따른 최종적인 모형식은 다음과 같다.
- ${\hat{y}} = -2.2800 + 0.7560x_{2} + 0.0003x_{3} + 30.630x_{4}$
- $y$ : 환기율, $x _{2}$ : 외부풍속, $x_{3}$ : 외부일사량, $x_{4}$ : 환기창면적 
- 즉, 환기율은 외부풍속, 외부일사량, 환기창면적에 대해 모두 정비례하는 경향을 보이고 있다.
- 이 모형을 이용하여 test data에 대한 환기율의 예측값을 구하고 이를 바탕으로 예측력의 정확성을 판단하는 기준인 RMSE를 계산하도록 한다. 이는 다음과 같이 계산한다.
- $RMSE = \frac {1} {n} \sqrt {\sum _{i=1} ^{n} (y _{i} - {\hat{y _{i}}} ) ^{2}}$

```{r}
y_hat <- predict(m1,ex2_test)
RMSE <- mean(sum((ex2_test$환기율-y_hat)^2))
RMSE
```

- 결과적으로 작물이 없는 경우 다중선형회귀모형을 적합했을 때 산출되는 RMSE는 $RMSE=28.49331$이다.



