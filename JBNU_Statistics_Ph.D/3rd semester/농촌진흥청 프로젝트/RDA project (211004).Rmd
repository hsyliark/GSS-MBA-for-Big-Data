---
title: "RDA project (211004)"
author: "Hwang Seong-Yun"
date: '2021 11 4 '
output: html_document
---

# 농촌진흥청 프로젝트

## 목적 : 단동 비닐하우스 환기율 및 온습도에 대한 예측모형 구축 및 평가
## 사용모형 : Multiple Linear Regression Model v.s Artificial Neural Network Model (ANN)

### Loading data

- 작물있음 데이터에서 외부CO2의 값이 결측치인 경우는 제외하였음.

```{r}
plantyes <- read.csv("C:/Users/HSY/Desktop/작물있음.csv",sep=",",header=T)
plantyes <- plantyes[is.na(plantyes$외부CO2)==FALSE,]
head(plantyes,10)
plantyes$작물유무 <- as.factor(plantyes$작물유무)
plantno <- read.csv("C:/Users/HSY/Desktop/작물없음.csv",sep=",",header=T)
head(plantno,10) 
plantno$작물유무 <- as.factor(plantno$작물유무)
plant <- rbind(plantyes,plantno)
```

### Open library

```{r}
library(nnet)
library(devtools)
library(neuralnet)
library(NeuralNetTools)
```

- 작물유무에 따라 데이터를 나누어서 사전분석을 실시한 결과 구축된 모형에 많은 차이가 있었다. 이에 따라 작물있음 데이터와 작물없음 데이터를 합친 데이터에 대해 작물유무와 다른 독립변수들간의 교호작용을 포함한 모형을 적합하여 결과를 살펴보았다.



# 1. 환기율 ~ 외부기온, 외부풍속, 외부일사량, 환기창면적, 작물유무

## 작물이 있는 경우

### Multiple Linear Regression Model

- 먼저 변수들 간의 상관관계를 파악하기 위해 상관분석을 실시한다.

```{r}
ex1_yes <- plantyes[,c(12,1,10,11,13)]
head(ex1_yes)
```

```{r}
cor(ex1_yes)
```

- 분석결과, pearson 표본상관계수에 따르면 환기창면적과 외부기온, 환기창면적과 외부일사량은 약한 음의 상관관계를 보이고 있으며, 나머지는 모두 양의 상관관계를 보이고 있다. 이를 그림으로 그리면 다음과 같다.

```{r}
library(corrplot)
corrplot(cor(ex1_yes))
```

- 그리고 각 변수에 대한 기초통계량은 다음과 같이 계산된다. 이 결과에 의하면 5가지 변수들 중 외부일사량이 가장 변동이 크다고 할 수 있다.

```{r}
library(psych)
describe(ex1_yes)
```

- 모형을 적합하기 전 주어진 데이터를 임의로 train:test=7:3으로 나누어서 train data를 가지고 적절한 모형을 적합하고 이 모형을 test data를 이용하여 평가할 것이다. 이는 ANN을 적용하는 경우에도 마찬가지이다.

```{r}
set.seed(5790)
train.index <- sample(1:nrow(ex1_yes), round(nrow(ex1_yes)*7/10), replace=F)
ex1_yes_train <- ex1_yes[train.index,]
ex1_yes_test <- ex1_yes[-train.index,]
```

- train data에 대해 다중선형회귀모형을 다음과 같이 적합할 수 있다.

```{r}
m0 <- lm(환기율~외부기온+외부풍속+외부일사량+환기창면적,data=ex1_yes_train)
summary(m0)
```

- 모형적합 결과 외부기온, 외부풍속, 외부일사량, 환기창면적 모두 환기율에 유의미한 영향을 미치고 있다고 보여진다. 그리고 조절된 결정계수의 값이 $R^2_{adj}=0.9533$이므로 이 모형이 데이터의 변동을 약 $95.3%$ 정도 설명하고 있으므로 설명력도 크다는 것을 알 수 있다. 따라서 더이상의 변수선택과정은 필요없을 것으로 판단되며 이에 따라 최종적인 모형식을 다음과 같이 표현할 수 있겠다.
- ${\hat{y}} = -3.5600 - 0.0393x_{1} + 1.9896x_{2} + 0.0015x_{3} + 45.2233x_{4}$
- $y$ : 환기율, $x _{1}$ : 외부기온, $x _{2}$ : 외부풍속, $x_{3}$ : 외부일사량, $x_{4}$ : 환기창면적 
- 즉, 환기율은 외부기온에 대해서만 반비례하는 경향을 보이고 나머지 변수들에 대해서는 모두 정비례하는 경향을 보이고 있다.
- 이 모형을 이용하여 test data에 대한 환기율의 예측값을 구하고 이를 바탕으로 예측력의 정확성을 판단하는 기준인 RMSE를 계산하도록 한다. 이는 다음과 같이 계산한다.
- $RMSE = \frac {1} {n} \sqrt {\sum _{i=1} ^{n} (y _{i} - {\hat{y _{i}}} ) ^{2}}$

```{r}
y_hat <- predict(m0,ex1_yes_test)
RMSE <- mean(sum((ex1_yes_test$환기율-y_hat)^2))
RMSE
```

- 결과적으로 작물이 있는 경우 다중선형회귀모형을 적합했을 때 산출되는 RMSE는 $RMSE=113.8861$이다.

### ANN Model

- ANN 모형의 경우는 다음과 같이 적합할 수 있다. hidden node의 경우는 개수를 결정하는 기준점이 따로 정해져있지 않기 때문에 최적의 hidden node의 개수를 미리 정한다는 것은 매우 어려운 일이다. 이에 따라 기본적으로 hidden layer의 개수는 2, 그리고 각각의 layer에 대한 node의 수는 3으로 설정한다. 
- 한가지 주의할 점은 ANN의 경우는 기본적으로 모든 설명변수들을 다 사용하게 되지만 정확한 모형식은 알 수 없기 때문에 각 설명변수의 유의성은 판단할 수 없다는 것이다.
- `neuralnet` 함수는 실행할 때마다 결과값이 다르게 나오기 때문에 `set.seed()`를 통해 미리 재현성을 확보해야 한다. 그리고 함수 실행 시 시간이 다소 소요된다.

```{r}
set.seed(1234)
ann1 <- neuralnet(환기율~외부기온+외부풍속+외부일사량+환기창면적, data=ex1_yes_train, hidden=c(3,3), threshold = 0.01, stepmax = 1e+06)
```

- 모형적합 결과, 4(입력)-2(은닉)-1(출력) 형태의 신경망 모형이 구성되었고, 총 13개의 가중치를 확인할 수 있다.
- 적합한 모형을 그림으로 나타내면 다음과 같다.

```{r}
plot(ann1)
```

- 이 모형을 이용하여 test data에 대한 환기율의 예측값을 구하고 이를 바탕으로 예측력의 정확성을 판단하는 기준인 RMSE를 계산하도록 한다. 이는 다음과 같이 계산한다.
- $RMSE = \frac {1} {n} \sqrt {\sum _{i=1} ^{n} (y _{i} - {\hat{y _{i}}} ) ^{2}}$

```{r}
y_hat_ann1 <- compute(ann1, ex1_yes_test)$net.result
RMSE <- mean(sum((ex1_yes_test$환기율-y_hat_ann1)^2))
RMSE
```

- 결과적으로 산출되는 RMSE의 값은 $RMSE=212.1349$이다. 이는 다중선형회귀모형의 결과보다 더 큰 값이기 때문에 hidden layer와 node의 수, 그리고 threshold나 stepmax 같은 tuning parameter를 조절해준다면 인공신경망의 결과가 더 좋아질 수도 있다. 다음과 같이 hidden layer의 개수는 3, 각각의 layer에 대한 node의 수는 5인 좀 더 복잡한 모형을 적합해보도록 한다.  

```{r}
set.seed(1234)
ann2 <- neuralnet(환기율~외부기온+외부풍속+외부일사량+환기창면적, data=ex1_yes_train, hidden=c(5,5,5), threshold = 0.06, stepmax = 1e+07)
```

```{r}
plot(ann2)
```

```{r}
y_hat_ann2 <- compute(ann2, ex1_yes_test)$net.result
RMSE <- mean(sum((ex1_yes_test$환기율-y_hat_ann2)^2))
RMSE
```

- 더 복잡한 모형을 적합한 결과 산출되는 RMSE의 값은 $RMSE=22.01621$로 매우 작아졌으며, 다중선형회귀모형과 비교했을 경우에도 더 좋은 결과를 보여주었다. 즉, 인공신경망의 모형이 복잡해질수록 예측력이 더 좋아질 가능성이 크다는 사실을 알 수 있다.



## 작물이 없는 경우

- 작물이 있는 경우와 동일한 과정으로 분석을 실시한다.

### Multiple Linear Regression Model

- 먼저 변수들 간의 상관관계를 파악하기 위해 상관분석을 실시한다.

```{r}
ex1_no <- plantno[,c(12,1,10,11,13)]
head(ex1_no)
```

```{r}
cor(ex1_no)
```

- 분석결과, pearson 표본상관계수에 따르면 환기창면적과 외부기온, 환기창면적과 외부일사량은 약한 음의 상관관계를 보이고 있으며, 나머지는 모두 양의 상관관계를 보이고 있다. 이를 그림으로 그리면 다음과 같다.

```{r}
corrplot(cor(ex1_no))
```

- 그리고 각 변수에 대한 기초통계량은 다음과 같이 계산된다. 이 결과에 의하면 5가지 변수들 중 외부일사량이 가장 변동이 크다고 할 수 있다.

```{r}
describe(ex1_no)
```

- 모형을 적합하기 전 주어진 데이터를 임의로 train:test=7:3으로 나누어서 train data를 가지고 적절한 모형을 적합하고 이 모형을 test data를 이용하여 평가할 것이다. 이는 ANN을 적용하는 경우에도 마찬가지이다.

```{r}
set.seed(5790)
train.index <- sample(1:nrow(ex1_no), round(nrow(ex1_no)*7/10), replace=F)
ex1_no_train <- ex1_no[train.index,]
ex1_no_test <- ex1_no[-train.index,]
```

- train data에 대해 다중선형회귀모형을 다음과 같이 적합할 수 있다.

```{r}
m0 <- lm(환기율~외부기온+외부풍속+외부일사량+환기창면적,data=ex1_no_train)
summary(m0)
```

- 모형적합 결과 외부풍속, 외부일사량, 환기창면적 모두 환기율에 유의미한 영향을 미치고 있지만, 외부기온은 유의미한 영향력이 없음을 알 수 있다. 이에 따라 stepwise selection을 통해 적절한 변수를 선택하는 과정이 필요하다고 판단된다.

```{r}
m1 <- step(m0)
summary(m1)
```

- stepwise selection에 따른 최종적인 모형식은 다음과 같다.
- ${\hat{y}} = -2.2800 + 0.7560x_{2} + 0.0003x_{3} + 30.630x_{4}$
- $y$ : 환기율, $x _{2}$ : 외부풍속, $x_{3}$ : 외부일사량, $x_{4}$ : 환기창면적 
- 즉, 환기율은 외부풍속, 외부일사량, 환기창면적에 대해 모두 정비례하는 경향을 보이고 있다.
- 이 모형을 이용하여 test data에 대한 환기율의 예측값을 구하고 이를 바탕으로 예측력의 정확성을 판단하는 기준인 RMSE를 계산하도록 한다. 이는 다음과 같이 계산한다.
- $RMSE = \frac {1} {n} \sqrt {\sum _{i=1} ^{n} (y _{i} - {\hat{y _{i}}} ) ^{2}}$

```{r}
y_hat <- predict(m1,ex1_no_test)
RMSE <- mean(sum((ex1_no_test$환기율-y_hat)^2))
RMSE
```

- 결과적으로 작물이 있는 경우 다중선형회귀모형을 적합했을 때 산출되는 RMSE는 $RMSE=28.49331$이다.




## 작물이 있는 경우 vs 작물이 없는 경우

### Multiple Linear Regression Model

